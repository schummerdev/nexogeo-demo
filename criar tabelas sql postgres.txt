-- Tabela para armazenar os dados da emissora (pode ter apenas uma linha)
CREATE TABLE emissoras (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    logo_url TEXT,
    tema_cor VARCHAR(50) DEFAULT 'branco'
);

-- Tabela para os usuários administradores do painel
CREATE TABLE usuarios_admin (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha_hash VARCHAR(255) NOT NULL,
    criado_em TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabela para cadastrar as promoções
CREATE TABLE promocoes (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    descricao TEXT,
    data_inicio DATE NOT NULL,
    data_fim DATE NOT NULL,
    status VARCHAR(50) DEFAULT 'ativa', -- ex: ativa, inativa, finalizada
    criado_em TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabela principal para registrar os participantes
CREATE TABLE participantes (
    id SERIAL PRIMARY KEY,
    promocao_id INT NOT NULL,
    nome VARCHAR(255) NOT NULL,
    telefone VARCHAR(20) NOT NULL,
    bairro VARCHAR(255),
    cidade VARCHAR(255),
    -- Armazena a geolocalização como coordenadas simples (latitude e longitude)
    latitude DECIMAL(10, 8), -- Latitude com precisão de 8 casas decimais
    longitude DECIMAL(11, 8), -- Longitude com precisão de 8 casas decimais
    origem_source VARCHAR(100), -- utm_source (ex: qrcode_tv)
    origem_medium VARCHAR(100), -- utm_medium (ex: tv)
    participou_em TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (promocao_id) REFERENCES promocoes(id) ON DELETE CASCADE
);

-- Tabela para registrar os ganhadores de cada sorteio
CREATE TABLE ganhadores (
    id SERIAL PRIMARY KEY,
    promocao_id INT NOT NULL,
    participante_id INT NOT NULL,
    sorteado_em TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (promocao_id) REFERENCES promocoes(id),
    FOREIGN KEY (participante_id) REFERENCES participantes(id)
);

-- Cria índices para otimizar consultas
CREATE INDEX idx_participantes_geolocalizacao ON participantes (latitude, longitude);
CREATE INDEX idx_participantes_telefone ON participantes (telefone);
CREATE UNIQUE INDEX idx_participante_unico_por_promocao ON participantes (promocao_id, telefone);

