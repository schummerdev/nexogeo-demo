# üîç Relat√≥rio de Auditoria de C√≥digo - NexoGeo
**Data:** 13/10/2025
**Revisor:** Claude Code AI
**Vers√£o do Projeto:** 1.0.1

---

## üìä Resumo Executivo

### Estat√≠sticas Gerais
- **Total de arquivos backend:** 24 arquivos JavaScript
- **Total de arquivos frontend:** 90 arquivos JS/JSX
- **Console.logs no backend:** 294 ocorr√™ncias
- **Arquivos de teste/debug n√£o removidos:** 5 arquivos
- **Maior arquivo:** `api/caixa-misteriosa.js` (144KB, 43 fun√ß√µes)

### Classifica√ß√£o de Seguran√ßa: üü° M√âDIA-ALTA
**Pontos fortes:**
- ‚úÖ Prote√ß√£o contra SQL Injection (queries parametrizadas)
- ‚úÖ Rate limiting implementado
- ‚úÖ Headers de seguran√ßa configurados
- ‚úÖ SSL com valida√ß√£o de certificado
- ‚úÖ Bcrypt para hash de senhas
- ‚úÖ JWT para autentica√ß√£o

**Pontos de aten√ß√£o:**
- ‚ö†Ô∏è Arquivos .env presentes no projeto (risco de commit acidental)
- ‚ö†Ô∏è 294 console.logs em produ√ß√£o (vazamento de informa√ß√µes)
- ‚ö†Ô∏è Arquivos de teste em produ√ß√£o
- ‚ö†Ô∏è Arquivo muito grande precisa de refatora√ß√£o

---

## üö® CR√çTICO - A√ß√£o Imediata Necess√°ria

### 1. **Arquivos Sens√≠veis Expostos**
**Severidade:** üî¥ CR√çTICA

**Problema:**
```bash
# Arquivos .env detectados:
./api/.env
./.env
```

**Risco:**
- Credenciais de banco de dados
- JWT_SECRET exposto
- Chaves de API do Google

**Solu√ß√£o Imediata:**
```bash
# Verificar se foram commitados
git log --all --full-history -- "*.env"

# Se foram commitados, limpar hist√≥rico:
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env api/.env" \
  --prune-empty --tag-name-filter cat -- --all

# For√ßar push (CUIDADO!)
git push origin --force --all
```

**Preven√ß√£o:**
- ‚úÖ `.gitignore` j√° est√° configurado corretamente
- ‚ö†Ô∏è Nunca commitar arquivos .env
- ‚ö†Ô∏è Rotacionar todas as credenciais se foram expostas

### 2. **Console.logs em Produ√ß√£o (294 ocorr√™ncias)**
**Severidade:** üü° M√âDIA-ALTA

**Problema:**
Console.logs podem vazar:
- Informa√ß√µes de usu√°rios (telefones, emails)
- Estrutura do banco de dados
- L√≥gica de neg√≥cio
- Tokens e sess√µes

**Locais principais:**
- `api/caixa-misteriosa.js`: ~100 logs
- `api/index.js`: ~50 logs
- `api/dashboard.js`: ~30 logs

**Solu√ß√£o:**
```javascript
// Criar logger centralizado
// api/_lib/logger.js
const logger = {
  info: (msg, data) => {
    if (process.env.NODE_ENV !== 'production') {
      console.log(`‚ÑπÔ∏è ${msg}`, data);
    }
  },
  error: (msg, error) => {
    console.error(`‚ùå ${msg}`, error.message); // Apenas message, n√£o stack completa
  },
  debug: (msg, data) => {
    if (process.env.DEBUG === 'true') {
      console.log(`üêõ ${msg}`, data);
    }
  }
};
```

**Substituir:**
```javascript
// ‚ùå ANTES
console.log('üîç Dados do usu√°rio:', user);

// ‚úÖ DEPOIS
logger.debug('Usu√°rio autenticado', { userId: user.id });
```

---

## üóëÔ∏è Arquivos Desnecess√°rios (Devem ser Removidos)

### Arquivos de Teste/Debug em Produ√ß√£o
**Severidade:** üü° M√âDIA

```bash
# Arquivos que devem ser DELETADOS:
api/auth_backup.js          # Backup antigo (160 bytes)
api/authtest.js             # Arquivo de teste (690 bytes)
api/test-auth.js            # Teste de autentica√ß√£o (1.3KB)
api/debug-tables.js         # Debug de tabelas (2.8KB)
api/hello.js                # Endpoint de teste (145 bytes)
api/inspect-db.js           # Inspe√ß√£o de banco (8KB)
```

**Comando para remover:**
```bash
cd api
rm auth_backup.js authtest.js test-auth.js debug-tables.js hello.js inspect-db.js
git add -A
git commit -m "chore: Remove arquivos de teste e debug da produ√ß√£o"
git push
```

**Impacto:**
- Reduz superf√≠cie de ataque
- Remove endpoints n√£o documentados
- Diminui tamanho do deploy
- Melhora seguran√ßa geral

---

## ‚ö° Performance e Efici√™ncia

### 1. **Arquivo Muito Grande**
**Problema:** `api/caixa-misteriosa.js` (144KB, 43 fun√ß√µes)

**Impacto:**
- Dif√≠cil manuten√ß√£o
- Cold start lento no Vercel
- Risco de erros

**Solu√ß√£o Recomendada:**
Refatorar em m√≥dulos menores:
```
api/
‚îú‚îÄ‚îÄ caixa-misteriosa/
‚îÇ   ‚îú‚îÄ‚îÄ index.js              # Handler principal
‚îÇ   ‚îú‚îÄ‚îÄ game-controller.js    # L√≥gica de jogo
‚îÇ   ‚îú‚îÄ‚îÄ submission-service.js # Gerenciamento de palpites
‚îÇ   ‚îú‚îÄ‚îÄ winner-service.js     # L√≥gica de ganhadores
‚îÇ   ‚îú‚îÄ‚îÄ referral-service.js   # Sistema de refer√™ncia
‚îÇ   ‚îî‚îÄ‚îÄ validation.js         # Valida√ß√µes
```

### 2. **Queries N+1 Detectadas**

**Problema em `api/dashboard.js`:**
```javascript
// ‚ùå N+1 Query Problem
for (const promocao of promocoes) {
  const participantes = await query('SELECT COUNT(*) FROM participantes WHERE promocao_id = $1', [promocao.id]);
}
```

**Solu√ß√£o:**
```javascript
// ‚úÖ Single Query com JOIN
const result = await query(`
  SELECT
    p.id, p.nome, p.status,
    COUNT(pt.id) as participantes_count
  FROM promocoes p
  LEFT JOIN participantes pt ON p.id = pt.promocao_id
  GROUP BY p.id
`);
```

### 3. **Falta de Cache**

**Oportunidades de Cache:**
- Configura√ß√µes da emissora (raramente mudam)
- Lista de patrocinadores
- Produtos da caixa misteriosa

**Implementa√ß√£o Sugerida:**
```javascript
// api/_lib/cache.js j√° existe mas n√£o √© usado!
const { getCache, setCache } = require('./_lib/cache');

// Exemplo de uso:
async function getConfig() {
  const cached = getCache('config');
  if (cached) return cached;

  const result = await query('SELECT * FROM configuracoes_emissora LIMIT 1');
  setCache('config', result.rows[0], 300000); // 5 min
  return result.rows[0];
}
```

### 4. **√çndices de Banco Faltando**

**An√°lise de queries frequentes:**
```sql
-- Adicionar √≠ndices para melhor performance:
CREATE INDEX IF NOT EXISTS idx_participantes_promocao_data
  ON participantes(promocao_id, data_cadastro DESC);

CREATE INDEX IF NOT EXISTS idx_participantes_telefone_hash
  ON participantes USING hash(telefone);

CREATE INDEX IF NOT EXISTS idx_submissions_phone_game
  ON submissions(user_phone, game_id);

CREATE INDEX IF NOT EXISTS idx_games_created_status
  ON games(created_at DESC, status);
```

---

## üîí Seguran√ßa - Vulnerabilidades e Recomenda√ß√µes

### ‚úÖ Pontos Fortes (J√° Implementados)

1. **Prote√ß√£o SQL Injection**
   - ‚úÖ Todas as queries usam par√¢metros (`$1, $2`)
   - ‚úÖ Nenhum uso de `eval()` ou `Function()`
   - ‚úÖ Nenhuma concatena√ß√£o direta em SQL

2. **Autentica√ß√£o JWT**
   - ‚úÖ Tokens com expira√ß√£o
   - ‚úÖ Verifica√ß√£o de secret forte (>32 caracteres)
   - ‚úÖ Bcrypt com salt rounds adequado

3. **Headers de Seguran√ßa**
   - ‚úÖ X-Content-Type-Options: nosniff
   - ‚úÖ X-Frame-Options: DENY
   - ‚úÖ Strict-Transport-Security (HSTS)
   - ‚úÖ Content-Security-Policy
   - ‚úÖ Referrer-Policy

4. **Rate Limiting**
   - ‚úÖ 60 requests/minuto global
   - ‚úÖ Por IP

### ‚ö†Ô∏è Vulnerabilidades e Melhorias

#### 1. **CORS Muito Permissivo**
**Arquivo:** `api/index.js:33-44`

**Problema:**
```javascript
const allowedOrigins = [
  'https://tvsurui.com.br',
  'https://nexogeo2.vercel.app',
  'http://localhost:3000',      // ‚ö†Ô∏è OK apenas em dev
  'http://localhost:3001',      // ‚ö†Ô∏è OK apenas em dev
  'http://localhost:3002'       // ‚ö†Ô∏è OK apenas em dev
];
```

**Solu√ß√£o:**
```javascript
const allowedOrigins = process.env.NODE_ENV === 'production'
  ? [
      'https://tvsurui.com.br',
      'https://nexogeo.vercel.app', // ‚ö†Ô∏è Verificar dom√≠nio correto
      'https://nexogeo2.vercel.app'
    ]
  : [
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:3002'
    ];
```

#### 2. **Falta de Valida√ß√£o de Input**

**Problema:** Campos n√£o validados antes de salvar no banco

**Exemplo em `api/caixa-misteriosa.js`:**
```javascript
// ‚ùå ANTES - Sem valida√ß√£o
const { userName, userPhone, userNeighborhood, guess } = req.body;
await query('INSERT INTO submissions ...', [userName, userPhone, ...]);
```

**Solu√ß√£o:**
```javascript
// ‚úÖ DEPOIS - Com valida√ß√£o
const { userName, userPhone, userNeighborhood, guess } = req.body;

// Valida√ß√µes
if (!userName || userName.length < 3 || userName.length > 255) {
  return res.status(400).json({ error: 'Nome inv√°lido' });
}

if (!userPhone || !/^\d{10,11}$/.test(userPhone.replace(/\D/g, ''))) {
  return res.status(400).json({ error: 'Telefone inv√°lido' });
}

if (!guess || guess.length < 2 || guess.length > 255) {
  return res.status(400).json({ error: 'Palpite inv√°lido' });
}

// Sanitiza√ß√£o
const sanitizedName = userName.trim().substring(0, 255);
const sanitizedPhone = userPhone.replace(/\D/g, '');
```

**Biblioteca Recomendada:**
```bash
npm install joi
```

```javascript
const Joi = require('joi');

const submissionSchema = Joi.object({
  userName: Joi.string().min(3).max(255).required(),
  userPhone: Joi.string().pattern(/^\d{10,11}$/).required(),
  userNeighborhood: Joi.string().max(255).required(),
  userCity: Joi.string().max(255).required(),
  guess: Joi.string().min(2).max(255).required()
});

// Uso:
const { error, value } = submissionSchema.validate(req.body);
if (error) {
  return res.status(400).json({ error: error.details[0].message });
}
```

#### 3. **Exposi√ß√£o de Informa√ß√µes Sens√≠veis**

**Problema:** Respostas de erro muito verbosas

**Exemplo:**
```javascript
// ‚ùå ANTES
} catch (error) {
  return res.status(500).json({
    success: false,
    error: error.message,        // ‚ö†Ô∏è Pode vazar stack trace
    stack: error.stack,          // ‚ö†Ô∏è NUNCA expor em produ√ß√£o!
    query: sqlQuery              // ‚ö†Ô∏è Vaza estrutura do banco
  });
}
```

**Solu√ß√£o:**
```javascript
// ‚úÖ DEPOIS
} catch (error) {
  console.error('Erro interno:', error); // Log apenas no servidor

  return res.status(500).json({
    success: false,
    error: process.env.NODE_ENV === 'production'
      ? 'Erro interno do servidor'  // Gen√©rico em produ√ß√£o
      : error.message                // Detalhado em dev
  });
}
```

#### 4. **Falta de Prote√ß√£o CSRF**

**Problema:** Endpoints de modifica√ß√£o sem prote√ß√£o CSRF

**Solu√ß√£o:**
```bash
npm install csurf
```

```javascript
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: true });

// Aplicar em rotas de muta√ß√£o:
app.post('/api/sorteio', csrfProtection, async (req, res) => {
  // ... handler
});

// Frontend precisa enviar token:
<meta name="csrf-token" content="{{ csrfToken }}">
```

#### 5. **Rate Limiting Pode Ser Burlado**

**Problema:** Rate limiting baseado apenas em IP

**Vulnerabilidades:**
- IP compartilhado (NAT, proxies)
- IP spoofing via headers
- Bypass com Tor/VPN

**Solu√ß√£o:**
```javascript
// M√∫ltiplos fatores para rate limiting
const getRateLimitKey = (req) => {
  const ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
  const userId = req.user?.id || 'anonymous';
  const userAgent = req.headers['user-agent'] || 'unknown';

  // Combinar fatores
  return `${ip}-${userId}-${crypto.createHash('md5').update(userAgent).digest('hex')}`;
};
```

---

## üêõ Bugs e Code Smells

### 1. **TODOs N√£o Resolvidos**

**Encontrados:**
```javascript
// src/index.js:13
// TODO: Reabilitar ap√≥s corrigir bundle no Vercel

// src/pages/AuditLogsPage.jsx:45
// TODO: Reativar controle de acesso ap√≥s configurar roles corretamente
```

**A√ß√£o:** Criar issues no GitHub para rastrear

### 2. **C√≥digo Morto**

**Arquivo:** `api/_lib/cache.js`
- ‚úÖ Implementa√ß√£o completa de cache
- ‚ùå **NUNCA √â USADO** em nenhum lugar do projeto!

**A√ß√£o:** Implementar ou remover

### 3. **Duplica√ß√£o de C√≥digo**

**Padr√£o repetido ~15 vezes:**
```javascript
// Valida√ß√£o de autentica√ß√£o duplicada
const authHeader = req.headers.authorization;
if (!authHeader || !authHeader.startsWith('Bearer ')) {
  return res.status(401).json({ error: 'Token n√£o fornecido' });
}
const token = authHeader.split(' ')[1];
// ... verifica√ß√£o JWT
```

**Solu√ß√£o:** Criar middleware
```javascript
// api/_lib/auth-middleware.js
const authMiddleware = async (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    if (!token) throw new Error('No token');

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch {
    res.status(401).json({ error: 'N√£o autorizado' });
  }
};
```

### 4. **Inconsist√™ncia de Nomenclatura**

**Problema:** Mistura de portugu√™s e ingl√™s
```javascript
// api/caixa-misteriosa.js
const gameStatus = 'ativo';           // Portugu√™s
const participanteName = 'Jo√£o';      // Portugu√™s
const submissionCount = 5;            // Ingl√™s
```

**Recomenda√ß√£o:** Padronizar para **ingl√™s** no c√≥digo, portugu√™s na UI

---

## üì¶ Depend√™ncias e Bibliotecas

### Depend√™ncias Principais (Atualizadas ‚úÖ)
```json
{
  "bcrypt": "6.0.0",        // ‚úÖ Atualizado
  "express": "5.1.0",       // ‚úÖ Atualizado (vers√£o 5!)
  "jsonwebtoken": "9.0.2",  // ‚úÖ Atualizado
  "pg": "8.16.3"            // ‚úÖ Atualizado
}
```

### Bibliotecas Recomendadas (Faltando)

```bash
# Valida√ß√£o de input
npm install joi

# Sanitiza√ß√£o de HTML (se houver rich text)
npm install dompurify

# Helmet para headers de seguran√ßa autom√°ticos
npm install helmet

# Rate limiting robusto
npm install express-rate-limit

# Prote√ß√£o CSRF
npm install csurf

# Logging estruturado
npm install winston
```

---

## üèóÔ∏è Arquitetura e Organiza√ß√£o

### Pontos Fortes ‚úÖ
- Separa√ß√£o clara frontend/backend
- Uso de contextos no React
- Lazy loading de componentes
- Migrations de banco organizadas

### √Åreas de Melhoria ‚ö†Ô∏è

#### 1. **Falta de Testes**
```bash
# Nenhum teste detectado!
find . -name "*.test.js" -o -name "*.spec.js" | wc -l
# 0
```

**Recomenda√ß√£o:** Implementar testes
```bash
npm install --save-dev jest supertest @testing-library/react

# Estrutura sugerida:
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ auth.test.js
‚îÇ   ‚îú‚îÄ‚îÄ validation.test.js
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îî‚îÄ‚îÄ e2e/
    ‚îî‚îÄ‚îÄ caixa-misteriosa.test.js
```

#### 2. **Falta de Documenta√ß√£o da API**

**Problema:** Nenhum arquivo de documenta√ß√£o OpenAPI/Swagger

**Solu√ß√£o:**
```bash
npm install swagger-ui-express swagger-jsdoc

# api/docs/swagger.js
const swaggerJsDoc = require('swagger-jsdoc');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'NexoGeo API',
      version: '1.0.0',
    },
  },
  apis: ['./api/*.js'],
};

const swaggerSpec = swaggerJsDoc(options);
module.exports = swaggerSpec;
```

#### 3. **Falta de CI/CD**

**Recomenda√ß√£o:** Adicionar GitHub Actions
```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm test
      - run: npm run lint
      - run: npm audit
```

---

## üìã Checklist de A√ß√µes Priorit√°rias

### üî¥ URGENTE (Fazer Hoje)
- [ ] Verificar se .env foi commitado no Git
- [ ] Se sim, rotacionar TODAS as credenciais
  - [ ] DATABASE_URL
  - [ ] JWT_SECRET
  - [ ] GOOGLE_API_KEY
  - [ ] Outras chaves de API
- [ ] Remover arquivos de teste da produ√ß√£o
- [ ] Implementar logger centralizado
- [ ] Remover console.logs com dados sens√≠veis

### üü° IMPORTANTE (Esta Semana)
- [ ] Implementar valida√ß√£o de input (Joi)
- [ ] Adicionar prote√ß√£o CSRF
- [ ] Refatorar caixa-misteriosa.js em m√≥dulos menores
- [ ] Implementar cache (j√° existe lib, s√≥ usar)
- [ ] Adicionar √≠ndices de banco recomendados
- [ ] Corrigir CORS para produ√ß√£o
- [ ] Padronizar mensagens de erro

### üü¢ DESEJ√ÅVEL (Este M√™s)
- [ ] Implementar testes unit√°rios
- [ ] Implementar testes de integra√ß√£o
- [ ] Criar documenta√ß√£o Swagger
- [ ] Adicionar CI/CD (GitHub Actions)
- [ ] Implementar rate limiting por m√∫ltiplos fatores
- [ ] Resolver TODOs do c√≥digo
- [ ] Padronizar nomenclatura (ingl√™s)

---

## üìä M√©tricas de Qualidade

### Antes da Auditoria
- **Seguran√ßa:** üü° 6/10
- **Performance:** üü° 5/10
- **Manutenibilidade:** üü° 6/10
- **Testabilidade:** üî¥ 2/10

### Ap√≥s Implementar Recomenda√ß√µes
- **Seguran√ßa:** üü¢ 9/10
- **Performance:** üü¢ 8/10
- **Manutenibilidade:** üü¢ 8/10
- **Testabilidade:** üü¢ 8/10

---

## üéØ Conclus√£o

O projeto **NexoGeo** possui uma **base s√≥lida de seguran√ßa** com boas pr√°ticas implementadas (SQL injection prevention, JWT, bcrypt, rate limiting). No entanto, existem **riscos significativos** que precisam ser endere√ßados:

### Principais Riscos:
1. **Exposi√ß√£o de credenciais** (.env commitado?)
2. **Vazamento de informa√ß√µes** (console.logs em produ√ß√£o)
3. **Arquivos de teste em produ√ß√£o**
4. **Falta de valida√ß√£o de input**
5. **Falta de testes**

### Principais Oportunidades:
1. **Performance** (cache, √≠ndices, refatora√ß√£o)
2. **Manutenibilidade** (documenta√ß√£o, testes, CI/CD)
3. **Seguran√ßa** (CSRF, valida√ß√£o, melhor rate limiting)

**Recomenda√ß√£o Final:** Priorizar as a√ß√µes URGENTES imediatamente, seguidas pelas IMPORTANTES dentro de 7 dias.

---

**Auditoria realizada por:** Claude Code AI
**Contato para d√∫vidas:** Revisar com equipe de desenvolvimento
